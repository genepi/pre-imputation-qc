---
title: "Relatedness"
date: "`r Sys.Date()`"
output:
  rmdformats::robobook:
    self_contained: true
    thumbnails: false
    lightbox: true
    gallery: false
    highlight: tango
params:
  genome_filename: /Users/lukfor/Askimed Dropbox/Lukas Forer/Genepi/Projekte/covid-gwas/gwas/20211206/new-paca/plink.genome
  kin_filename: /Users/lukfor/plink2.kin0
  famname: /Users/lukfor/Askimed Dropbox/Lukas Forer/Genepi/Projekte/covid-gwas/gwas/20211206/new-paca/covid-gwas.fam
---

```{r setup, include=FALSE}
library(ggplot2)
library(DT)
library(dplyr)
library(igraph)

knitr::opts_chunk$set(echo = FALSE)
```


# Pairwise IBD estimation (Plink)

Using estimates of pairwise IBD to find pairs of individuals who look too similar to eachother, i.e. more than we would expect by chance in a random sample.

```{r warning=FALSE}

data = read.table(params$genome_filename, h=T)

hist(data$PI_HAT, col="RED", breaks=100, xlab="Estimated mean pairwise IBD", main="")

plot(data$PI_HAT, xlab="Index", ylab="Proportion IBD")
abline(h=0.1875,col="RED",lty=2)

out = data %>% filter(PI_HAT > 0.1875)


g <- graph.data.frame(out %>% select("IID1","IID2"), directed=FALSE)

# Remove unnecessary margins
par(mar = c(0, 0, 0, 0))
plot(g, vertex.size = 1,layout = layout.fruchterman.reingold,
     edge.arrow.size = 0.5, vertex.label = NA, edge.width = out$PI_HAT * 3,)

out_filtered = out %>% select("IID1","IID2","PI_HAT")

datatable(out_filtered, options = list(order = list(list(3, 'desc'))))

write.table(out_filtered, "ibd.samples.txt", append = FALSE, sep = " ", dec = ".",
            row.names = FALSE, col.names = TRUE,  quote = FALSE)

```

Calculating the average pi-hat for each individual and looking for outliers is also useful (in particular, sample contamination will lead to too many heterozygote calls, which leads to fewer IBS 0 calls, which leads to over-estimated IBD with all other people in the sample). 

```{r warning=FALSE}

dst = data
ind <- read.table(params$famname, header=F, stringsAsFactors=F)
ind$AvgDST <- NA
for (i in 1:nrow(ind)) {
    ind$AvgDST[i] <- mean(dst[dst$IID1==ind$V2[i] | dst$IID2==ind$V2[i], c("DST")])
}
ind<-ind[, c("V1","V2","AvgDST")]


plot(density(ind$AvgDST), main="Average DST", xlab="AvgDST")
rug(ind$AvgDST)
abline(v=0.678, col="blue")
abline(v=0.66, col="blue")

dst = data.frame(
	FID=ind$V1,
	IID=ind$V2,
	AVGDST=ind$AvgDST
)
#datatable(dst)

```


# KING-robust kinship estimator (Plink)

Note that KING kinship coefficients are scaled such that duplicate samples have kinship 0.5, not 1. First-degree relations (parent-child, full siblings) correspond to ~0.25, second-degree relations correspond to ~0.125, etc. It is conventional to use a cutoff of ~0.354 (the geometric mean of 0.5 and 0.25) to screen for monozygotic twins and duplicate samples, ~0.177 to add first-degree relations, etc.

```{r warning=FALSE}

kin = read.table(params$kin_filename, h=T, comment.char = '')

hist(kin$KINSHIP, col="RED", breaks=100, xlab="KINSHIP", main="")

plot(kin$KINSHIP, xlab="Index", ylab="KINSHIP")
abline(h=0.1875/2,col="RED",lty=2)

out = kin %>% filter(KINSHIP > 0.1875/2)

g <- graph.data.frame(out %>% select("ID1","ID2"), directed=FALSE)

# Remove unnecessary margins
par(mar = c(0, 0, 0, 0))
plot(g, vertex.size = 1,layout = layout.fruchterman.reingold,
     edge.arrow.size = 0.5,  edge.width = out$KINSHIP * 5,  vertex.label = NA)

out_filtered = out %>% select("ID1","ID2","KINSHIP")
datatable(out_filtered, options = list(order = list(list(3, 'desc'))))

write.table(out_filtered, "kinship.samples.txt", append = FALSE, sep = " ", dec = ".",
            row.names = FALSE, col.names = TRUE,  quote = FALSE)

```
